# 1. Classifier Guidance

用贝叶斯概率可以将条件生成概率进行分解

如下式：
$$
\begin{align*}  
\nabla \log p(x_t \mid y) &= \nabla \log \left( \frac{p(x_t) \, p(y \mid x_t)}{p(y)} \right) \\
&= \nabla \log p(x_t) + \nabla \log p(y \mid x_t) - \nabla \log p(y) \\
&= \underbrace{\nabla \log p(x_t)}_{\text{unconditional score}} + \underbrace{\nabla \log p(y \mid x_t)}_{\text{classifier gradient}}  
\end{align*}
$$
从上式可以看到，Classifier Guidance**条件生成只需额外添加一个classifier的梯度来引导。从成本上看，Classifier Guidance 需要训练噪声数据版本的classifier网络，推理时每一步都需要额外计算classifier的梯度**

也就是使用Classifier Guidance可以节约训练成本，但是会增加推理成本。

# 2. Classifier-free Guidance

**Classifier Guidance 使用显式的分类器引导条件生成有几个问题**：一是需要额外训练一个噪声版本的[图像分类器](https://zhida.zhihu.com/search?q=图像分类器&zhida_source=entity&is_preview=1)。二是该分类器的质量会影响按类别生成的效果。三是通过梯度更新图像会导致[对抗攻击效应](https://zhida.zhihu.com/search?q=对抗攻击效应&zhida_source=entity&is_preview=1)，生成图像可能会通过人眼不可察觉的细节欺骗分类器，实际上并没有按条件生成。

2022年谷歌提出**Classifier-Free Guidance方**案，可以规避上述问题，而且可以通过调节引导权重，控制生成图像的逼真性和多样性的平衡，**DALL·E 2和Imagen等模型都是以它为基础进行训练和推理**

Classifier-Free Guidance的权重用于控制图像生成的逼真性和多样性。

**Classifier-Free Guidance的核心是通过一个[隐式分类器](https://zhida.zhihu.com/search?q=隐式分类器&zhida_source=entity&is_preview=1)来替代显示分类器，而无需直接计算显式分类器及其梯度**。根据[贝叶斯公式](https://zhida.zhihu.com/search?q=贝叶斯公式&zhida_source=entity&is_preview=1)，**分类器的梯度可以用条件生成概率和无条件生成概率表示**：
$$
\begin{align*}  
\nabla_{x_t} \log p(y \mid x_t) &= \nabla_{x_t} \log p(x_t \mid y) - \nabla_{x_t} \log p(x_t) \\
&= -\frac{1}{\sqrt{1 - \bar{\alpha}_t}} \left( \epsilon_\theta(x_t, t, y) - \epsilon_\theta(x_t, t) \right)  
\end{align*}
$$
把上面的[分类器梯度](https://zhida.zhihu.com/search?q=分类器梯度&zhida_source=entity&is_preview=1)代入到**classifier guidance**的分类器梯度中可得：
$$
\begin{align*}  
\bar{\epsilon}_\theta (x_t, t, y) &= \epsilon_\theta (x_t, t, y) - \sqrt{1 - \bar{\alpha}_t} w \nabla_{x_t} \log p(y \mid x_t) \\
&= \epsilon_\theta (x_t, t, y) + w \left( \epsilon_\theta (x_t, t, y) - \epsilon_\theta (x_t, t) \right) \\
&= (w + 1) \epsilon_\theta (x_t, t, y) - w \epsilon_\theta (x_t, t)  
\end{align*}
$$
由上可知，新的生成过程**不再依赖显示的classifier**，因而解决了上述Classifier Guidance的几个问题。

**总的来说，训练时，Classifier-Free Guidance需要训练两个模型，一个是无条件[生成模型](https://zhida.zhihu.com/search?q=生成模型&zhida_source=entity&is_preview=1)，另一个是条件生成模型。**但这两个模型可以用同一个模型表示，**训练时只需要以一定概率将条件置空即可。**

**推理时，最终结果可以由条件生成和无条件生成的线性外推获得，生成效果可以引导系数可以调节，控制生成样本的逼真性和多样性的平衡。**

# 3. Diffusion Model 生成相关指标

